/**
 * @fileoverview added by tsickle
 * Generated from: lib/lazy-elements/lazy-elements-loader.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { Inject, Injectable, Optional } from '@angular/core';
import { LAZY_ELEMENT_ROOT_OPTIONS, LAZY_ELEMENTS_REGISTRY, } from './lazy-elements.tokens';
import * as i0 from "@angular/core";
import * as i1 from "./lazy-elements.tokens";
/** @type {?} */
const LOG_PREFIX = '@angular-extensions/elements';
/**
 * @record
 */
export function HooksConfig() { }
if (false) {
    /** @type {?|undefined} */
    HooksConfig.prototype.beforeLoad;
    /** @type {?|undefined} */
    HooksConfig.prototype.afterLoad;
}
/**
 * @record
 */
export function ElementConfig() { }
if (false) {
    /** @type {?} */
    ElementConfig.prototype.tag;
    /** @type {?} */
    ElementConfig.prototype.url;
    /** @type {?|undefined} */
    ElementConfig.prototype.isModule;
    /** @type {?|undefined} */
    ElementConfig.prototype.importMap;
    /** @type {?|undefined} */
    ElementConfig.prototype.loadingComponent;
    /** @type {?|undefined} */
    ElementConfig.prototype.errorComponent;
    /** @type {?|undefined} */
    ElementConfig.prototype.preload;
    /** @type {?|undefined} */
    ElementConfig.prototype.hooks;
    /** @type {?|undefined} */
    ElementConfig.prototype.isAdded;
}
export class LazyElementsLoaderService {
    /**
     * @param {?} registry
     * @param {?} options
     */
    constructor(registry, options) {
        this.registry = registry;
        this.options = options;
        this.configs = [];
        if (!options) {
            this.options = {};
        }
    }
    /**
     * @param {?} newConfigs
     * @return {?}
     */
    addConfigs(newConfigs) {
        newConfigs.forEach((/**
         * @param {?} newConfig
         * @return {?}
         */
        (newConfig) => {
            /** @type {?} */
            const existingConfig = this.getElementConfig(newConfig.tag);
            if (existingConfig) {
                console.warn(`${LOG_PREFIX} - ElementConfig for tag '${newConfig.tag}' was previously added, it will not be added multiple times, continue...`);
            }
            else {
                newConfig.isAdded = true;
                this.configs.push(newConfig);
                /** @type {?} */
                const shouldPreload = newConfig.preload !== undefined
                    ? newConfig.preload
                    : this.options.preload;
                if (shouldPreload) {
                    this.loadElement(newConfig.url, newConfig.tag, newConfig.isModule, newConfig.importMap, newConfig.hooks);
                }
            }
        }));
    }
    /**
     * @param {?} tag
     * @return {?}
     */
    getElementConfig(tag) {
        return this.configs.find((/**
         * @param {?} config
         * @return {?}
         */
        (config) => config.tag === tag));
    }
    /**
     * @param {?=} tags
     * @return {?}
     */
    preload(tags) {
        /** @type {?} */
        let configs = this.configs;
        if (tags) {
            configs = this.configs.filter((/**
             * @param {?} config
             * @return {?}
             */
            (config) => tags.includes(config.tag)));
        }
        configs.forEach((/**
         * @param {?} config
         * @return {?}
         */
        (config) => this.loadElement(config.url, config.tag, config.isModule, config.importMap, config.hooks)));
    }
    /**
     * @param {?} url
     * @param {?} tag
     * @param {?=} isModule
     * @param {?=} importMap
     * @param {?=} hooksConfig
     * @return {?}
     */
    loadElement(url, tag, isModule, importMap, hooksConfig) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m;
        return __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const config = this.getElementConfig(tag);
            isModule !== null && isModule !== void 0 ? isModule : (isModule = (_a = config === null || config === void 0 ? void 0 : config.isModule) !== null && _a !== void 0 ? _a : this.options.isModule);
            importMap !== null && importMap !== void 0 ? importMap : (importMap = (_b = config === null || config === void 0 ? void 0 : config.importMap) !== null && _b !== void 0 ? _b : this.options.importMap);
            if (!tag) {
                throw new Error(`${LOG_PREFIX} - tag for '${url}' not found, the *axLazyElement has to be used on HTML element`);
            }
            if (!url) {
                if (!(config === null || config === void 0 ? void 0 : config.url) && !importMap) {
                    throw new Error(`${LOG_PREFIX} - url for <${tag}> not found`);
                }
                else if (importMap) {
                    url = tag;
                }
                else {
                    url = config.url;
                }
            }
            if (!this.hasElement(url)) {
                /** @type {?} */
                const notifier = this.addElement(url);
                /** @type {?} */
                const beforeLoadHook = (_e = (_c = hooksConfig === null || hooksConfig === void 0 ? void 0 : hooksConfig.beforeLoad) !== null && _c !== void 0 ? _c : (_d = config === null || config === void 0 ? void 0 : config.hooks) === null || _d === void 0 ? void 0 : _d.beforeLoad) !== null && _e !== void 0 ? _e : (_g = (_f = this.options) === null || _f === void 0 ? void 0 : _f.hooks) === null || _g === void 0 ? void 0 : _g.beforeLoad;
                /** @type {?} */
                const afterLoadHook = (_k = (_h = hooksConfig === null || hooksConfig === void 0 ? void 0 : hooksConfig.afterLoad) !== null && _h !== void 0 ? _h : (_j = config === null || config === void 0 ? void 0 : config.hooks) === null || _j === void 0 ? void 0 : _j.afterLoad) !== null && _k !== void 0 ? _k : (_m = (_l = this.options) === null || _l === void 0 ? void 0 : _l.hooks) === null || _m === void 0 ? void 0 : _m.afterLoad;
                if (importMap) {
                    url = yield this.resolveImportMap(url);
                }
                /** @type {?} */
                const script = (/** @type {?} */ (document.createElement('script')));
                if (isModule) {
                    script.type = 'module';
                }
                script.src = url;
                script.onload = (/**
                 * @return {?}
                 */
                () => {
                    if (afterLoadHook) {
                        this.handleHook(afterLoadHook, tag)
                            .then(notifier.resolve)
                            .catch(notifier.reject);
                    }
                    else {
                        notifier.resolve();
                    }
                });
                script.onerror = notifier.reject;
                if (beforeLoadHook) {
                    this.handleHook(beforeLoadHook, tag)
                        .then((/**
                     * @return {?}
                     */
                    () => document.body.appendChild(script)))
                        .catch(notifier.reject);
                }
                else {
                    document.body.appendChild(script);
                }
            }
            return this.registry.get(this.stripUrlProtocol(url));
        });
    }
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    addElement(url) {
        /** @type {?} */
        let notifier;
        this.registry.set(this.stripUrlProtocol(url), new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => (notifier = { resolve, reject }))));
        return notifier;
    }
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    hasElement(url) {
        return this.registry.has(this.stripUrlProtocol(url));
    }
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    stripUrlProtocol(url) {
        return url.replace(/https?:\/\//, '');
    }
    /**
     * @private
     * @param {?} hook
     * @param {?} tag
     * @return {?}
     */
    handleHook(hook, tag) {
        try {
            return Promise.resolve(hook(tag));
        }
        catch (err) {
            return Promise.reject(err);
        }
    }
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    resolveImportMap(url) {
        return __awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            const System = ((/** @type {?} */ (window))).System;
            if (System) {
                yield System.prepareImport();
                url = System.resolve(url);
            }
            else {
                throw new Error(`${LOG_PREFIX} - importMap feature depends on SystemJS library to be globally loaded but none was found, thus '${url}' can't be resolved. You should either load SystemJS or remove the importMap flag.`);
            }
            return url;
        });
    }
}
LazyElementsLoaderService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
/** @nocollapse */
LazyElementsLoaderService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [LAZY_ELEMENTS_REGISTRY,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [LAZY_ELEMENT_ROOT_OPTIONS,] }] }
];
/** @nocollapse */ LazyElementsLoaderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function LazyElementsLoaderService_Factory() { return new LazyElementsLoaderService(i0.ɵɵinject(i1.LAZY_ELEMENTS_REGISTRY), i0.ɵɵinject(i1.LAZY_ELEMENT_ROOT_OPTIONS, 8)); }, token: LazyElementsLoaderService, providedIn: "root" });
if (false) {
    /** @type {?} */
    LazyElementsLoaderService.prototype.configs;
    /**
     * @type {?}
     * @private
     */
    LazyElementsLoaderService.prototype.registry;
    /** @type {?} */
    LazyElementsLoaderService.prototype.options;
}
/**
 * @record
 */
function Notifier() { }
if (false) {
    /** @type {?} */
    Notifier.prototype.resolve;
    /** @type {?} */
    Notifier.prototype.reject;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS1lbGVtZW50cy1sb2FkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS90cmF2aXMvYnVpbGQvYW5ndWxhci1leHRlbnNpb25zL2VsZW1lbnRzL3Byb2plY3RzL2VsZW1lbnRzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9sYXp5LWVsZW1lbnRzL2xhenktZWxlbWVudHMtbG9hZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFRLE1BQU0sZUFBZSxDQUFDO0FBR25FLE9BQU8sRUFDTCx5QkFBeUIsRUFDekIsc0JBQXNCLEdBRXZCLE1BQU0sd0JBQXdCLENBQUM7Ozs7TUFFMUIsVUFBVSxHQUFHLDhCQUE4Qjs7OztBQUlqRCxpQ0FHQzs7O0lBRkMsaUNBQWtCOztJQUNsQixnQ0FBaUI7Ozs7O0FBR25CLG1DQVVDOzs7SUFUQyw0QkFBWTs7SUFDWiw0QkFBWTs7SUFDWixpQ0FBbUI7O0lBQ25CLGtDQUFvQjs7SUFDcEIseUNBQTZCOztJQUM3Qix1Q0FBMkI7O0lBQzNCLGdDQUFrQjs7SUFDbEIsOEJBQW9COztJQUNwQixnQ0FBa0I7O0FBTXBCLE1BQU0sT0FBTyx5QkFBeUI7Ozs7O0lBR3BDLFlBQzBDLFFBQThCLEVBRy9ELE9BQStCO1FBSEUsYUFBUSxHQUFSLFFBQVEsQ0FBc0I7UUFHL0QsWUFBTyxHQUFQLE9BQU8sQ0FBd0I7UUFOeEMsWUFBTyxHQUFvQixFQUFFLENBQUM7UUFRNUIsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1NBQ25CO0lBQ0gsQ0FBQzs7Ozs7SUFFRCxVQUFVLENBQUMsVUFBMkI7UUFDcEMsVUFBVSxDQUFDLE9BQU87Ozs7UUFBQyxDQUFDLFNBQVMsRUFBRSxFQUFFOztrQkFDekIsY0FBYyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsR0FB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QyxJQUFVLEVBQUUsR0FBVztRQUN4QyxJQUFJO1lBQ0YsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ25DO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDNUI7SUFDSCxDQUFDOzs7Ozs7SUFFYSxnQkFBZ0IsQ0FBQyxHQUFXOzs7a0JBQ2xDLE1BQU0sR0FBRyxDQUFDLG1CQUFBLE1BQU0sRUFBTyxDQUFDLENBQUMsTUFBTTtZQUNyQyxJQUFJLE1BQU0sRUFBRTtnQkFDVixNQUFNLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDN0IsR0FBRyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDM0I7aUJBQU07Z0JBQ0wsTUFBTSxJQUFJLEtBQUssQ0FDYixHQUFHLFVBQVUsb0dBQW9HLEdBQUcsb0ZBQW9GLENBQ3pNLENBQUM7YUFDSDtZQUNELE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQztLQUFBOzs7WUF6S0YsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7OzRDQUtJLE1BQU0sU0FBQyxzQkFBc0I7NENBQzdCLFFBQVEsWUFDUixNQUFNLFNBQUMseUJBQXlCOzs7OztJQUxuQyw0Q0FBOEI7Ozs7O0lBRzVCLDZDQUFzRTs7SUFDdEUsNENBRXNDOzs7OztBQWtLMUMsdUJBR0M7OztJQUZDLDJCQUFvQjs7SUFDcEIsMEJBQTZCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBMYXp5RWxlbWVudFJvb3RPcHRpb25zIH0gZnJvbSAnLi9sYXp5LWVsZW1lbnRzLm1vZHVsZSc7XG5pbXBvcnQge1xuICBMQVpZX0VMRU1FTlRfUk9PVF9PUFRJT05TLFxuICBMQVpZX0VMRU1FTlRTX1JFR0lTVFJZLFxuICBMYXp5RWxlbWVudHNSZWdpc3RyeSxcbn0gZnJvbSAnLi9sYXp5LWVsZW1lbnRzLnRva2Vucyc7XG5cbmNvbnN0IExPR19QUkVGSVggPSAnQGFuZ3VsYXItZXh0ZW5zaW9ucy9lbGVtZW50cyc7XG5cbmV4cG9ydCB0eXBlIEhvb2sgPSAodGFnOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4gfCB2b2lkO1xuXG5leHBvcnQgaW50ZXJmYWNlIEhvb2tzQ29uZmlnIHtcbiAgYmVmb3JlTG9hZD86IEhvb2s7XG4gIGFmdGVyTG9hZD86IEhvb2s7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRWxlbWVudENvbmZpZyB7XG4gIHRhZzogc3RyaW5nO1xuICB1cmw6IHN0cmluZztcbiAgaXNNb2R1bGU/OiBib29sZWFuO1xuICBpbXBvcnRNYXA/OiBib29sZWFuO1xuICBsb2FkaW5nQ29tcG9uZW50PzogVHlwZTxhbnk+O1xuICBlcnJvckNvbXBvbmVudD86IFR5cGU8YW55PjtcbiAgcHJlbG9hZD86IGJvb2xlYW47XG4gIGhvb2tzPzogSG9va3NDb25maWc7XG4gIGlzQWRkZWQ/OiBib29sZWFuO1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgTGF6eUVsZW1lbnRzTG9hZGVyU2VydmljZSB7XG4gIGNvbmZpZ3M6IEVsZW1lbnRDb25maWdbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoTEFaWV9FTEVNRU5UU19SRUdJU1RSWSkgcHJpdmF0ZSByZWdpc3RyeTogTGF6eUVsZW1lbnRzUmVnaXN0cnksXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KExBWllfRUxFTUVOVF9ST09UX09QVElPTlMpXG4gICAgcHVibGljIG9wdGlvbnM6IExhenlFbGVtZW50Um9vdE9wdGlvbnNcbiAgKSB7XG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSB7fTtcbiAgICB9XG4gIH1cblxuICBhZGRDb25maWdzKG5ld0NvbmZpZ3M6IEVsZW1lbnRDb25maWdbXSkge1xuICAgIG5ld0NvbmZpZ3MuZm9yRWFjaCgobmV3Q29uZmlnKSA9PiB7XG4gICAgICBjb25zdCBleGlzdGluZ0NvbmZpZyA9IHRoaXMuZ2V0RWxlbWVudENvbmZpZyhuZXdDb25maWcudGFnKTtcbiAgICAgIGlmIChleGlzdGluZ0NvbmZpZykge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgYCR7TE9HX1BSRUZJWH0gLSBFbGVtZW50Q29uZmlnIGZvciB0YWcgJyR7bmV3Q29uZmlnLnRhZ30nIHdhcyBwcmV2aW91c2x5IGFkZGVkLCBpdCB3aWxsIG5vdCBiZSBhZGRlZCBtdWx0aXBsZSB0aW1lcywgY29udGludWUuLi5gXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdDb25maWcuaXNBZGRlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY29uZmlncy5wdXNoKG5ld0NvbmZpZyk7XG4gICAgICAgIGNvbnN0IHNob3VsZFByZWxvYWQgPVxuICAgICAgICAgIG5ld0NvbmZpZy5wcmVsb2FkICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgID8gbmV3Q29uZmlnLnByZWxvYWRcbiAgICAgICAgICAgIDogdGhpcy5vcHRpb25zLnByZWxvYWQ7XG4gICAgICAgIGlmIChzaG91bGRQcmVsb2FkKSB7XG4gICAgICAgICAgdGhpcy5sb2FkRWxlbWVudChcbiAgICAgICAgICAgIG5ld0NvbmZpZy51cmwsXG4gICAgICAgICAgICBuZXdDb25maWcudGFnLFxuICAgICAgICAgICAgbmV3Q29uZmlnLmlzTW9kdWxlLFxuICAgICAgICAgICAgbmV3Q29uZmlnLmltcG9ydE1hcCxcbiAgICAgICAgICAgIG5ld0NvbmZpZy5ob29rc1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGdldEVsZW1lbnRDb25maWcodGFnOiBzdHJpbmcpOiBFbGVtZW50Q29uZmlnIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWdzLmZpbmQoKGNvbmZpZykgPT4gY29uZmlnLnRhZyA9PT0gdGFnKTtcbiAgfVxuXG4gIHByZWxvYWQodGFncz86IHN0cmluZ1tdKSB7XG4gICAgbGV0IGNvbmZpZ3MgPSB0aGlzLmNvbmZpZ3M7XG4gICAgaWYgKHRhZ3MpIHtcbiAgICAgIGNvbmZpZ3MgPSB0aGlzLmNvbmZpZ3MuZmlsdGVyKChjb25maWcpID0+IHRhZ3MuaW5jbHVkZXMoY29uZmlnLnRhZykpO1xuICAgIH1cbiAgICBjb25maWdzLmZvckVhY2goKGNvbmZpZykgPT5cbiAgICAgIHRoaXMubG9hZEVsZW1lbnQoXG4gICAgICAgIGNvbmZpZy51cmwsXG4gICAgICAgIGNvbmZpZy50YWcsXG4gICAgICAgIGNvbmZpZy5pc01vZHVsZSxcbiAgICAgICAgY29uZmlnLmltcG9ydE1hcCxcbiAgICAgICAgY29uZmlnLmhvb2tzXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWRFbGVtZW50KFxuICAgIHVybDogc3RyaW5nLFxuICAgIHRhZzogc3RyaW5nLFxuICAgIGlzTW9kdWxlPzogYm9vbGVhbixcbiAgICBpbXBvcnRNYXA/OiBib29sZWFuLFxuICAgIGhvb2tzQ29uZmlnPzogSG9va3NDb25maWdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5nZXRFbGVtZW50Q29uZmlnKHRhZyk7XG4gICAgaXNNb2R1bGUgPz89IGNvbmZpZz8uaXNNb2R1bGUgPz8gdGhpcy5vcHRpb25zLmlzTW9kdWxlO1xuICAgIGltcG9ydE1hcCA/Pz0gY29uZmlnPy5pbXBvcnRNYXAgPz8gdGhpcy5vcHRpb25zLmltcG9ydE1hcDtcblxuICAgIGlmICghdGFnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGAke0xPR19QUkVGSVh9IC0gdGFnIGZvciAnJHt1cmx9JyBub3QgZm91bmQsIHRoZSAqYXhMYXp5RWxlbWVudCBoYXMgdG8gYmUgdXNlZCBvbiBIVE1MIGVsZW1lbnRgXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdXJsKSB7XG4gICAgICBpZiAoIWNvbmZpZz8udXJsICYmICFpbXBvcnRNYXApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0xPR19QUkVGSVh9IC0gdXJsIGZvciA8JHt0YWd9PiBub3QgZm91bmRgKTtcbiAgICAgIH0gZWxzZSBpZiAoaW1wb3J0TWFwKSB7XG4gICAgICAgIHVybCA9IHRhZztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHVybCA9IGNvbmZpZy51cmw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmhhc0VsZW1lbnQodXJsKSkge1xuICAgICAgY29uc3Qgbm90aWZpZXIgPSB0aGlzLmFkZEVsZW1lbnQodXJsKTtcblxuICAgICAgY29uc3QgYmVmb3JlTG9hZEhvb2sgPVxuICAgICAgICBob29rc0NvbmZpZz8uYmVmb3JlTG9hZCA/P1xuICAgICAgICBjb25maWc/Lmhvb2tzPy5iZWZvcmVMb2FkID8/XG4gICAgICAgIHRoaXMub3B0aW9ucz8uaG9va3M/LmJlZm9yZUxvYWQ7XG4gICAgICBjb25zdCBhZnRlckxvYWRIb29rID1cbiAgICAgICAgaG9va3NDb25maWc/LmFmdGVyTG9hZCA/P1xuICAgICAgICBjb25maWc/Lmhvb2tzPy5hZnRlckxvYWQgPz9cbiAgICAgICAgdGhpcy5vcHRpb25zPy5ob29rcz8uYWZ0ZXJMb2FkO1xuXG4gICAgICBpZiAoaW1wb3J0TWFwKSB7XG4gICAgICAgIHVybCA9IGF3YWl0IHRoaXMucmVzb2x2ZUltcG9ydE1hcCh1cmwpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSBhcyBIVE1MU2NyaXB0RWxlbWVudDtcbiAgICAgIGlmIChpc01vZHVsZSkge1xuICAgICAgICBzY3JpcHQudHlwZSA9ICdtb2R1bGUnO1xuICAgICAgfVxuICAgICAgc2NyaXB0LnNyYyA9IHVybDtcbiAgICAgIHNjcmlwdC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIGlmIChhZnRlckxvYWRIb29rKSB7XG4gICAgICAgICAgdGhpcy5oYW5kbGVIb29rKGFmdGVyTG9hZEhvb2ssIHRhZylcbiAgICAgICAgICAgIC50aGVuKG5vdGlmaWVyLnJlc29sdmUpXG4gICAgICAgICAgICAuY2F0Y2gobm90aWZpZXIucmVqZWN0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBub3RpZmllci5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBzY3JpcHQub25lcnJvciA9IG5vdGlmaWVyLnJlamVjdDtcbiAgICAgIGlmIChiZWZvcmVMb2FkSG9vaykge1xuICAgICAgICB0aGlzLmhhbmRsZUhvb2soYmVmb3JlTG9hZEhvb2ssIHRhZylcbiAgICAgICAgICAudGhlbigoKSA9PiBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCkpXG4gICAgICAgICAgLmNhdGNoKG5vdGlmaWVyLnJlamVjdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LmdldCh0aGlzLnN0cmlwVXJsUHJvdG9jb2wodXJsKSk7XG4gIH1cblxuICBwcml2YXRlIGFkZEVsZW1lbnQodXJsOiBzdHJpbmcpOiBOb3RpZmllciB7XG4gICAgbGV0IG5vdGlmaWVyOiBOb3RpZmllcjtcbiAgICB0aGlzLnJlZ2lzdHJ5LnNldChcbiAgICAgIHRoaXMuc3RyaXBVcmxQcm90b2NvbCh1cmwpLFxuICAgICAgbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4gKG5vdGlmaWVyID0geyByZXNvbHZlLCByZWplY3QgfSkpXG4gICAgKTtcbiAgICByZXR1cm4gbm90aWZpZXI7XG4gIH1cblxuICBwcml2YXRlIGhhc0VsZW1lbnQodXJsOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWdpc3RyeS5oYXModGhpcy5zdHJpcFVybFByb3RvY29sKHVybCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdHJpcFVybFByb3RvY29sKHVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdXJsLnJlcGxhY2UoL2h0dHBzPzpcXC9cXC8vLCAnJyk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUhvb2soaG9vazogSG9vaywgdGFnOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShob29rKHRhZykpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZXNvbHZlSW1wb3J0TWFwKHVybDogc3RyaW5nKSB7XG4gICAgY29uc3QgU3lzdGVtID0gKHdpbmRvdyBhcyBhbnkpLlN5c3RlbTtcbiAgICBpZiAoU3lzdGVtKSB7XG4gICAgICBhd2FpdCBTeXN0ZW0ucHJlcGFyZUltcG9ydCgpO1xuICAgICAgdXJsID0gU3lzdGVtLnJlc29sdmUodXJsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgJHtMT0dfUFJFRklYfSAtIGltcG9ydE1hcCBmZWF0dXJlIGRlcGVuZHMgb24gU3lzdGVtSlMgbGlicmFyeSB0byBiZSBnbG9iYWxseSBsb2FkZWQgYnV0IG5vbmUgd2FzIGZvdW5kLCB0aHVzICcke3VybH0nIGNhbid0IGJlIHJlc29sdmVkLiBZb3Ugc2hvdWxkIGVpdGhlciBsb2FkIFN5c3RlbUpTIG9yIHJlbW92ZSB0aGUgaW1wb3J0TWFwIGZsYWcuYFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHVybDtcbiAgfVxufVxuXG5pbnRlcmZhY2UgTm90aWZpZXIge1xuICByZXNvbHZlOiAoKSA9PiB2b2lkO1xuICByZWplY3Q6IChlcnJvcjogYW55KSA9PiB2b2lkO1xufVxuIl19